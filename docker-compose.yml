##
# @file docker-compose.yml
# @brief Docker Compose configuration for Maritime Onboarding System deployment
#
# @details This Docker Compose file defines a complete, self-contained maritime
# onboarding system deployment suitable for production environments. It orchestrates
# multiple services including database, API, frontend, email, and storage components
# with proper networking, security, and monitoring configurations.
#
# **System Architecture:**
# - **Database Layer**: PostgreSQL with PostgREST API
# - **Application Layer**: Node.js backend with React frontend
# - **Storage Layer**: MinIO for file and certificate storage
# - **Email Layer**: MailHog for development email testing
# - **Proxy Layer**: Nginx for load balancing and SSL termination
# - **Monitoring Layer**: Health checks and logging
#
# **Deployment Features:**
# - Complete containerized deployment
# - No external dependencies required
# - Automatic service discovery and networking
# - Persistent data storage with volume management
# - Health monitoring and automatic restart policies
# - Environment-based configuration management
# - SSL/TLS support for production security
#
# **Webhost/Infrastructure Benefits:**
# - **Single Command Deployment**: `docker-compose up -d`
# - **Scalable Architecture**: Easy horizontal scaling of services
# - **Resource Management**: Configurable CPU and memory limits
# - **Backup Integration**: Automated database and file backups
# - **Monitoring Ready**: Built-in health checks and logging
# - **Security Hardened**: Network isolation and access controls
# - **Update Management**: Rolling updates with zero downtime
#
# **Production Considerations:**
# - Configure environment variables for production settings
# - Set up SSL certificates for HTTPS termination
# - Configure backup schedules and retention policies
# - Set appropriate resource limits for each service
# - Configure monitoring and alerting systems
# - Implement log aggregation and analysis
#
# **Service Dependencies:**
# - Database must be healthy before API services start
# - Storage services must be available for file operations
# - Email service required for user notifications
# - Frontend depends on backend API availability
#
# **Network Architecture:**
# - Internal network for service-to-service communication
# - Exposed ports only for necessary external access
# - Load balancer for high availability and SSL termination
# - Service discovery through Docker DNS
#
# @author Maritime Onboarding System
# @version 3.0.0
# @since 2024
#
# @see README.md For deployment instructions
# @see DEPLOYMENT_OPTIES.md For production deployment options
# @see SECURITY_GUIDE.md For security configuration
##

# Maritime Onboarding System - Pure Docker Architecture
# Complete self-contained system with no external dependencies
# Version: 3.0.0

version: '3.8'

services:
  # ===========================================
  # DATABASE LAYER
  # ===========================================
  
  # PostgreSQL Database
  database:
    image: postgres:15-alpine
    container_name: maritime_database
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-maritime}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./backups:/backups
    networks:
      - maritime_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgREST API
  postgrest:
    image: postgrest/postgrest:v12.0.2
    container_name: maritime_postgrest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgres://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@database:5432/${DB_NAME:-maritime}
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_MAX_ROWS: 1000
      PGRST_SERVER_CORS_ALLOWED_ORIGINS: "*"
    ports:
      - "3001:3000"
    networks:
      - maritime_network
    depends_on:
      database:
        condition: service_healthy

  # PgAdmin Database Management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: maritime_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@maritime.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - maritime_network
    depends_on:
      database:
        condition: service_healthy

  # ===========================================
  # STORAGE LAYER
  # ===========================================

  # MinIO Object Storage (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: maritime_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    networks:
      - maritime_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Client for bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: maritime_minio_init
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - maritime_network
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set minio http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb --ignore-existing minio/uploads;
      mc mb --ignore-existing minio/certificates;
      mc mb --ignore-existing minio/training-proofs;
      mc mb --ignore-existing minio/documents;
      mc policy set public minio/uploads;
      mc policy set public minio/certificates;
      exit 0;
      "

  # ===========================================
  # APPLICATION LAYER
  # ===========================================

  # Backend API (Node.js)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: maritime_backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      # Database
      DB_HOST: database
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-maritime}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DATABASE_URL: postgres://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@database:5432/${DB_NAME:-maritime}
      # PostgREST
      POSTGREST_URL: http://postgrest:3000
      # Supabase
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      # Storage
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_USE_SSL: 'false'
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      # JWT & Auth
      JWT_SECRET: ${JWT_SECRET}
      NEXTAUTH_SECRET: ${JWT_SECRET}
      # Email
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
      MAIL_SECURE: 'false'
      # URLs
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      APP_URL: ${APP_URL:-http://localhost:3000}
    ports:
      - "3000:3000"
    volumes:
      - ./api:/app/api:ro
      - ./lib:/app/lib:ro
      - ./services:/app/services:ro
      - ./uploads:/app/uploads
    networks:
      - maritime_network
    depends_on:
      database:
        condition: service_healthy
      postgrest:
        condition: service_started
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend (React)
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: maritime_frontend
    restart: unless-stopped
    environment:
      REACT_APP_API_URL: ${API_URL:-http://localhost:3000}
      REACT_APP_POSTGREST_URL: ${POSTGREST_URL:-http://localhost:3001}
      REACT_APP_MINIO_URL: ${MINIO_URL:-http://localhost:9000}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./client/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - maritime_network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # SUPPORTING SERVICES
  # ===========================================

  # Email Service (MailHog for development)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: maritime_mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - maritime_network

  # Redis Cache (Optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: maritime_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - maritime_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backup Service
  backup:
    image: postgres:15-alpine
    container_name: maritime_backup
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - ./backups:/backups
      - ./scripts/backup.sh:/backup.sh:ro
    networks:
      - maritime_network
    depends_on:
      database:
        condition: service_healthy
    command: >
      sh -c "
      while true; do
        PGPASSWORD=${DB_PASSWORD:-postgres} pg_dump -h database -U ${DB_USER:-postgres} ${DB_NAME:-maritime} > /backups/backup_$$(date +%Y%m%d_%H%M%S).sql
        find /backups -name 'backup_*.sql' -mtime +7 -delete
        sleep 86400
      done
      "

# ===========================================
# NETWORKS
# ===========================================
networks:
  maritime_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ===========================================
# VOLUMES
# ===========================================
volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local
  pgadmin_data:
    driver: local
  redis_data:
    driver: local