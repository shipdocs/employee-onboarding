name: Code Quality & Maintainability

on:
  push:
    branches: [ master, testing, preview ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  knip-analysis:
    name: Unused Code Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci --legacy-peer-deps && cd ..
      
      - name: Run Knip Analysis
        run: |
          npm run knip > knip-report.txt || true
          echo "## ğŸ“Š Knip Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -s knip-report.txt ]; then
            head -20 knip-report.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No unused code detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Knip Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: knip-report
          path: knip-report.txt

  code-metrics:
    name: Code Metrics & Complexity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Calculate Metrics
        run: |
          echo "## ğŸ“ Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files by type
          echo "### File Count by Type" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | $(find . -name "*.js" -not -path "*/node_modules/*" -not -path "*/build/*" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | $(find . -name "*.ts" -not -path "*/node_modules/*" -not -path "*/build/*" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| JSX | $(find . -name "*.jsx" -not -path "*/node_modules/*" -not -path "*/build/*" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| TSX | $(find . -name "*.tsx" -not -path "*/node_modules/*" -not -path "*/build/*" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          
          # Total lines of code
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo "Total: $(find . \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) -not -path "*/node_modules/*" -not -path "*/build/*" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Run Audit
        run: |
          echo "## ğŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate > audit-report.txt 2>&1 || true
          
          if grep -q "found 0 vulnerabilities" audit-report.txt; then
            echo "âœ… No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat audit-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci --legacy-peer-deps && cd ..
      
      - name: Run Tests with Coverage
        run: |
          npm run test:coverage || echo "Test coverage not available, skipping..."
          
      - name: Generate Coverage Summary
        run: |
          echo "## ğŸ§ª Test Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            echo "Coverage data will be displayed here" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No coverage data found" >> $GITHUB_STEP_SUMMARY
          fi

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install and Build
        run: |
          npm ci
          cd client && npm ci --legacy-peer-deps && cd ..
          npm run build || echo "Build not available, skipping bundle analysis..."
      
      - name: Analyze Bundle
        run: |
          echo "## ğŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "build" ]; then
            echo "### Build Output Size" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            du -sh build/* | sort -hr | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Build Size:** $(du -sh build | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi

  maintainability-report:
    name: Generate Maintainability Report
    runs-on: ubuntu-latest
    needs: [knip-analysis, code-metrics, dependency-check, test-coverage, bundle-analysis]
    if: always()
    steps:
      - uses: actions/checkout@v4.2.2
      
      - name: Create Report
        run: |
          echo "# ğŸ“Š Code Quality Report" > maintainability-report.md
          echo "" >> maintainability-report.md
          echo "Generated: $(date)" >> maintainability-report.md
          echo "" >> maintainability-report.md
          
          echo "## Summary" >> maintainability-report.md
          echo "This automated report tracks code quality metrics for the Maritime Onboarding System." >> maintainability-report.md
          echo "" >> maintainability-report.md
          
          echo "## Action Items" >> maintainability-report.md
          echo "1. Review knip-report artifact for unused code" >> maintainability-report.md
          echo "2. Address any security vulnerabilities" >> maintainability-report.md
          echo "3. Improve test coverage where needed" >> maintainability-report.md
          echo "4. Monitor bundle size trends" >> maintainability-report.md
          
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: maintainability-report
          path: maintainability-report.md