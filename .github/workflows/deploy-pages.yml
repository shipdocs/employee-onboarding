name: Deploy GitHub Pages

on:
  push:
    branches: ["main", "master"]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'QUICK_START.md'
      - 'INSTALLATION_GUIDE.md'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          cache-version: 0
          
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4
        
      - name: Copy documentation files to docs
        run: |
          # Copy main documentation files to docs folder for Jekyll processing
          cp README.md docs/README.md || true
          cp QUICK_START.md docs/quickstart.md || true
          cp INSTALLATION_GUIDE.md docs/installation.md || true
          cp SECURITY.md docs/security.md || true
          cp CONTRIBUTING.md docs/contributing.md || true
          
          # Create features collection
          mkdir -p docs/_features
          
          # Create architecture diagram placeholder
          mkdir -p docs/assets/images
          
          # Create a simple SVG architecture diagram
          cat > docs/assets/images/architecture.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600">
            <rect x="50" y="50" width="700" height="500" fill="#f0f0f0" stroke="#333" stroke-width="2"/>
            <text x="400" y="100" text-anchor="middle" font-size="24" font-weight="bold">System Architecture</text>
            
            <!-- Frontend -->
            <rect x="100" y="150" width="150" height="80" fill="#61dafb" stroke="#333" stroke-width="2"/>
            <text x="175" y="195" text-anchor="middle" font-size="16" fill="white">React Frontend</text>
            
            <!-- Nginx -->
            <rect x="300" y="150" width="150" height="80" fill="#009639" stroke="#333" stroke-width="2"/>
            <text x="375" y="195" text-anchor="middle" font-size="16" fill="white">Nginx Proxy</text>
            
            <!-- Backend -->
            <rect x="500" y="150" width="150" height="80" fill="#68a063" stroke="#333" stroke-width="2"/>
            <text x="575" y="195" text-anchor="middle" font-size="16" fill="white">Node.js API</text>
            
            <!-- Database -->
            <rect x="100" y="280" width="150" height="80" fill="#336791" stroke="#333" stroke-width="2"/>
            <text x="175" y="325" text-anchor="middle" font-size="16" fill="white">PostgreSQL</text>
            
            <!-- Redis -->
            <rect x="300" y="280" width="150" height="80" fill="#dc382d" stroke="#333" stroke-width="2"/>
            <text x="375" y="325" text-anchor="middle" font-size="16" fill="white">Redis Cache</text>
            
            <!-- MinIO -->
            <rect x="500" y="280" width="150" height="80" fill="#c72e49" stroke="#333" stroke-width="2"/>
            <text x="575" y="325" text-anchor="middle" font-size="16" fill="white">MinIO Storage</text>
            
            <!-- Docker -->
            <rect x="250" y="410" width="250" height="80" fill="#2496ed" stroke="#333" stroke-width="2"/>
            <text x="375" y="455" text-anchor="middle" font-size="18" fill="white">Docker Container Platform</text>
          </svg>
          EOF
          
          # Use SVG as architecture image
          cp docs/assets/images/architecture.svg docs/assets/images/architecture.png || true
          
      - name: Build with Jekyll
        run: |
          cd docs
          gem install bundler jekyll jekyll-theme-cayman jekyll-seo-tag jekyll-sitemap jekyll-relative-links
          bundle install || true
          bundle exec jekyll build --baseurl "/employee-onboarding"
        env:
          JEKYLL_ENV: production
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4