name: Apply Database Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:

jobs:
  apply-migrations:
    name: Apply Migrations to Production
    runs-on: ubuntu-latest

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@f6c5353b2d6b8d8a0d0b8e6b2b6b2b6b2b6b2b6b # v1.1.0
        with:
          version: 1.127.4
      
      - name: Set Supabase project reference
        run: |
          echo "PROJECT_REF=ocqnnyxnqaedarcohywe" >> $GITHUB_ENV
          echo "ENV_NAME=Production" >> $GITHUB_ENV
      
      - name: Link to Supabase project
        run: supabase link --project-ref $PROJECT_REF
      
      - name: Apply migrations
        id: apply-migrations
        run: |
          echo "Applying migrations to $ENV_NAME environment ($PROJECT_REF)..."
          supabase db push
      
      - name: Log migration in database
        run: node scripts/log-migration.js
        env:
          MIGRATION_NAME: "github-action-${{ github.sha }}"
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          APPLIED_BY: ${{ github.actor }}
          NOTES: "Applied via GitHub Actions from ${{ github.repository }}@${{ github.ref }}"
          SUPABASE_URL: https://${{ env.PROJECT_REF }}.supabase.co
          SUPABASE_SERVICE_ROLE_KEY_TESTING: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_TESTING }}
          SUPABASE_SERVICE_ROLE_KEY_PREVIEW: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PREVIEW }}
          SUPABASE_SERVICE_ROLE_KEY_PRODUCTION: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PRODUCTION }}
      
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Migrations successfully applied to $ENV_NAME environment!"
          echo "Project: $PROJECT_REF"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Failed to apply migrations to $ENV_NAME environment!"
          echo "Project: $PROJECT_REF"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"